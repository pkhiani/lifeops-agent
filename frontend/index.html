<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOps | AI-Powered Immigration Navigator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        paper: '#E8E4DD',
                        signal: '#E63B2E',
                        offwhite: '#F5F3EE',
                        black: '#111111',
                    },
                    fontFamily: {
                        heading: ['Space Grotesk', 'sans-serif'],
                        drama: ['DM Serif Display', 'serif'],
                        data: ['Space Mono', 'monospace'],
                    },
                    borderRadius: {
                        'brutalist': '2.5rem',
                    }
                }
            }
        }
    </script>
    <!-- GSAP CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
    <!-- React & Babel CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Cytoscape -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>

    <link rel="stylesheet" href="styles.css">
    <style type="text/tailwindcss">
        @layer utilities {
            .backdrop-blur-xl { backdrop-filter: blur(24px); }
            .hide-scrollbar::-webkit-scrollbar { display: none; }
            .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        }
        
        #cy {
            width: 100%;
            height: 100%;
            background: #111;
        }

        .animate-pulse-slow {
            animation: pulse-slow 3s ease-in-out infinite;
        }

        @keyframes pulse-slow {
            0%, 100% { opacity: 0.1; transform: scale(1); }
            50% { opacity: 0.2; transform: scale(1.1); }
        }
    </style>
</head>

<body class="bg-offwhite text-black font-heading overflow-x-hidden transition-colors duration-700">
    <div id="root"></div>

    <!-- Global Noise Overlay (SVG Filter) -->
    <svg class="hidden">
        <filter id="noiseFilter">
            <feTurbulence type="fractalNoise" baseFrequency="0.6" numOctaves="3" stitchTiles="stitch" />
        </filter>
    </svg>
    <div class="noise-overlay" style="filter: url(#noiseFilter);"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect, useMemo } = React;

        const BACKEND_URL = 'https://lifeops-agent.onrender.com';

        const PERSONAS = {
            CHINESE_NEW_ARRIVAL: {
                transcript: "我刚刚到达洛杉矶，我需要办一张手机卡和银行卡，还有租房子。我拿的是F1签证。",
                facts: [
                    { entity: 'Location', value: 'Los Angeles, CA' },
                    { entity: 'Visa Status', value: 'F1 Student' },
                    { entity: 'Arrival Date', value: 'Recent' }
                ],
                tasks: [
                    { id: 101, title: 'Get US Phone Number', description: 'Visit a provider (T-Mobile/AT&T) with passport & I-20.', status: 'pending' },
                    { id: 102, title: 'Open Bank Account', description: 'Required: Passport, I-20, proof of residence.', status: 'pending' },
                    { id: 103, title: 'SEVIS Registration', description: 'Must check-in with the International Student Office.', status: 'pending' }
                ],
                logs: [
                    { message: 'MODULATE_AUDIO_INGEST: SUCCESS [TRANSCRIPT_MATCH: 98%]', type: 'system' },
                    { message: 'IDENTIFIED_LANGUAGE: MANDARIN (zh-CN) | REGION: SOUTH', type: 'agent' },
                    { message: 'YUTORI_INTENT_ENGINE: ANALYZING_CROSS_CULTURAL_CONTEXT...', type: 'agent' },
                    { message: 'EXTRACTED_FACTS: [F1_VISA_STATUS, LOS_ANGELES_GEO, RECENT_ARRIVAL_SIGNAL]', type: 'agent' },
                    { message: 'TASK_INITIALIZED: SETUP_US_CONNECTIVITY [PHONE_CARD]', type: 'system' },
                    { message: 'TASK_INITIALIZED: ESTABLISH_FINANCIAL_FOOTPRINT [BANK_ACC]', type: 'system' },
                    { message: 'TASK_INITIALIZED: IMMIGRATION_COMPLIANCE [SEVIS_CHECKIN]', type: 'system' },
                    { message: 'PROTOCOL_DEPLOYED: CHINESE_NEW_ARRIVAL_NAVIGATOR', type: 'agent' },
                    { message: 'LOGISTICAL_MAPPING_COMPLETE: READY_FOR_EXECUTION', type: 'agent' }
                ],
                apiCalls: [
                    { service: 'Modulate API', status: 'success' },
                    { service: 'Yutori Engine', status: 'success' },
                    { service: 'Google Maps API', status: 'success' },
                    { service: 'SEVIS System', status: 'success' }
                ]
            }
        };

        // --- Context & State Management ---

        const useAudioRecorder = (addLog, onProcessed) => {
            const [isRecording, setIsRecording] = useState(false);
            const [recordingText, setRecordingText] = useState('Tap to speak');
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);
            const recognitionRef = useRef(null);

            const start = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorderRef.current = new MediaRecorder(stream);
                    audioChunksRef.current = [];

                    mediaRecorderRef.current.ondataavailable = (e) => {
                        if (e.data.size > 0) audioChunksRef.current.push(e.data);
                    };

                    mediaRecorderRef.current.onstop = async () => {
                        const blob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
                        onProcessed(blob);
                    };

                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if (SpeechRecognition) {
                        recognitionRef.current = new SpeechRecognition();
                        recognitionRef.current.continuous = true;
                        recognitionRef.current.interimResults = true;
                        recognitionRef.current.onresult = (e) => {
                            let interim = '';
                            for (let i = e.resultIndex; i < e.results.length; ++i) {
                                interim += e.results[i][0].transcript;
                            }
                            // You could bubble this up for a live transcript view
                        };
                        recognitionRef.current.start();
                    }

                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                    setRecordingText('Recording...');
                    addLog('SECURE_AUDIO_INGEST: ACTIVE', 'system');
                } catch (err) {
                    console.error(err);
                    addLog('MICROPHONE_ACCESS_DENIED', 'error');
                }
            };

            const stop = () => {
                if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
                    mediaRecorderRef.current.stop();
                    if (recognitionRef.current) recognitionRef.current.stop();
                    setIsRecording(false);
                    setRecordingText('Processing...');
                    mediaRecorderRef.current.stream.getTracks().forEach(t => t.stop());
                }
            };

            return { isRecording, recordingText, start, stop, setRecordingText };
        };

        // --- Landing Page Components ---

        const Navbar = ({ onEnterApp }) => {
            const [scrolled, setScrolled] = useState(false);
            useEffect(() => {
                const handleScroll = () => setScrolled(window.scrollY > 50);
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            return (
                <nav className={`fixed top-6 left-1/2 -translate-x-1/2 z-50 transition-all duration-500 w-[90%] max-w-4xl px-8 py-4 rounded-full flex items-center justify-between border ${scrolled ? 'bg-offwhite/60 backdrop-blur-xl border-black/10' : 'bg-transparent border-transparent text-white'
                    }`}>
                    <div className="text-xl font-bold tracking-tighter">LIFEOPS</div>
                    <div className="hidden md:flex gap-8 text-sm font-medium">
                        <a href="#features" className="hover:opacity-60 transition-opacity">Features</a>
                        <a href="#philosophy" className="hover:opacity-60 transition-opacity">Philosophy</a>
                        <a href="#protocol" className="hover:opacity-60 transition-opacity">Protocol</a>
                    </div>
                    <button onClick={onEnterApp} className="btn-magnetic bg-signal text-white px-6 py-2 rounded-full text-sm font-bold group">
                        <span className="btn-layer"></span>
                        <span className="btn-text">Open Console</span>
                    </button>
                </nav>
            );
        };

        const Hero = ({ onEnterApp }) => {
            const heroRef = useRef();
            useLayoutEffect(() => {
                let ctx = gsap.context(() => {
                    gsap.from(".hero-content > *", { y: 60, opacity: 0, duration: 1.2, stagger: 0.15, ease: "power3.out" });
                }, heroRef);
                return () => ctx.revert();
            }, []);

            return (
                <section ref={heroRef} className="relative h-[100dvh] w-full bg-black overflow-hidden flex flex-col justify-end p-8 md:p-20">
                    <img src="https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?auto=format&fit=crop&q=80&w=2070" className="absolute inset-0 w-full h-full object-cover opacity-50 grayscale" alt="Brutalist Architecture" />
                    <div className="absolute inset-0 hero-gradient"></div>
                    <div className="hero-content relative z-10 max-w-5xl text-paper">
                        <h1>
                            <span className="block text-4xl md:text-6xl font-bold leading-tight tracking-tighter mb-2">Navigate the</span>
                            <span className="block text-7xl md:text-[10rem] font-drama leading-none text-signal">Migration Chaos.</span>
                        </h1>
                        <p className="text-white/60 text-lg md:text-2xl mt-8 max-w-2xl font-light">
                            LifeOps is an AI-powered navigator that turns complex immigration transitions into clear, actionable steps. Speak your mind, we'll handle the logistics.
                        </p>
                        <div className="mt-12">
                            <button onClick={onEnterApp} className="btn-magnetic bg-signal text-white px-10 py-5 rounded-full text-lg font-bold">
                                <span className="btn-layer"></span>
                                <span className="btn-text">Initialize Protocol</span>
                            </button>
                        </div>
                    </div>
                </section>
            );
        };

        const Features = () => (
            <section id="features" className="py-32 px-8 bg-offwhite">
                <div className="max-w-7xl mx-auto">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {/* Summary of feature blocks */}
                        {[
                            { title: "Intent Engine", icon: "brain-circuit", desc: "Understands context, emotions, and the nuances of your unique situation without rigid forms.", visual: "shuffle" },
                            { title: "Auto-Action", icon: "zap", desc: "LifeOps automatically identifies required actions, deadlines, and missing documents.", visual: "telemetry" },
                            { title: "Zero-Hesitation", icon: "eye", desc: "Monitor tasks and complete them without hesitation and on time, backed by real-time guidance.", visual: "scheduler" }
                        ].map((f, i) => (
                            <div key={i} className="bg-paper p-10 rounded-brutalist h-[500px] flex flex-col justify-between border border-black/5">
                                <div>
                                    <div className="w-12 h-12 bg-signal/10 rounded-full flex items-center justify-center mb-6">
                                        <i data-lucide={f.icon} className="text-signal w-6 h-6"></i>
                                    </div>
                                    <h3 className="text-3xl font-bold mb-4">{f.title}</h3>
                                    <p className="text-black/60">{f.desc}</p>
                                </div>
                                <div className="h-40 bg-black/5 rounded-2xl overflow-hidden p-6">
                                    {/* Simplified visuals for space */}
                                    <div className="font-data text-[10px] text-black/40 uppercase tracking-widest">{f.visual}_MODE: ACTIVATED</div>
                                    <div className="mt-4 w-full h-1 bg-black/10 rounded-full overflow-hidden">
                                        <div className="h-full bg-signal w-1/2 animate-shimmer"></div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </section>
        );

        // --- Console Components ---

        const Sidebar = ({ activeTab, setTab, onExit }) => (
            <aside className="w-20 md:w-64 bg-black h-full flex flex-col py-8 px-4 border-r border-white/10 z-20">
                <div className="mb-12 px-4 cursor-pointer" onClick={onExit}>
                    <h1 className="text-white text-xl font-bold tracking-tighter">LIFEOPS</h1>
                </div>
                <nav className="flex-1 flex flex-col gap-2">
                    {[
                        { id: 'dash', label: 'Console', icon: 'terminal' },
                        { id: 'tasks', label: 'Protocol', icon: 'clipboard-list' },
                        { id: 'profile', label: 'Identity', icon: 'user' },
                        { id: 'map', label: 'Reasoning', icon: 'share-2' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setTab(tab.id)}
                            className={`flex items-center gap-4 px-4 py-4 rounded-2xl transition-all ${activeTab === tab.id ? 'bg-signal text-white' : 'text-white/40 hover:text-white hover:bg-white/5'
                                }`}
                        >
                            <i data-lucide={tab.icon} className="w-5 h-5"></i>
                            <span className="hidden md:block font-bold text-sm tracking-tight">{tab.label}</span>
                        </button>
                    ))}
                </nav>
                <div className="mt-auto px-4 py-4 bg-white/5 rounded-2xl border border-white/10 flex items-center gap-4">
                    <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span className="hidden md:block font-data text-[10px] text-white/40">OPS_ACTIVE</span>
                </div>
            </aside>
        );

        const JourneyMap = ({ facts, apiCalls }) => {
            const cyRef = useRef(null);

            useEffect(() => {
                const elements = [
                    { data: { id: 'user', label: 'USER', type: 'user' } }
                ];
                facts.forEach((f, i) => {
                    elements.push({ data: { id: `f-${i}`, label: f.value, type: 'fact' } });
                    elements.push({ data: { source: 'user', target: `f-${i}`, label: f.entity } });
                });
                apiCalls.forEach((c, i) => {
                    const sId = `s-${c.service.toLowerCase()}`;
                    if (!elements.find(e => e.data.id === sId)) {
                        elements.push({ data: { id: sId, label: c.service, type: 'service' } });
                    }
                    elements.push({ data: { source: 'user', target: sId, label: 'CALL' } });
                });

                const cy = cytoscape({
                    container: document.getElementById('cy'),
                    elements: elements,
                    style: [
                        { selector: 'node', style: { 'background-color': '#444', 'label': 'data(label)', 'color': '#fff', 'font-family': 'Space Mono', 'font-size': '8px', 'text-valign': 'center', 'text-halign': 'center', 'width': 30, 'height': 30, 'border-width': 1, 'border-color': '#555' } },
                        { selector: 'node[type="user"]', style: { 'background-color': '#E63B2E', 'width': 40, 'height': 40 } },
                        { selector: 'node[type="service"]', style: { 'shape': 'diamond', 'background-color': '#888' } },
                        { selector: 'edge', style: { 'width': 1, 'line-color': '#333', 'target-arrow-color': '#333', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier', 'label': 'data(label)', 'color': '#444', 'font-size': '6px', 'text-rotation': 'autorotate', 'text-margin-y': -10 } }
                    ],
                    layout: { name: 'cose', animate: true, padding: 30 }
                });
                cyRef.current = cy;
            }, [facts, apiCalls]);

            return <div id="cy" className="rounded-brutalist overflow-hidden border border-white/10 shadow-2xl"></div>;
        };

        const Dashboard = ({ logs, onToggleRecord, isRecording, recordingText, transcript, onLoadMock }) => (
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 h-full">
                <div className="bg-black rounded-brutalist p-10 flex flex-col justify-between border border-white/10 shadow-2xl relative overflow-hidden group">
                    <div className="absolute inset-0 opacity-20 pointer-events-none">
                        <div className="w-full h-full bg-[radial-gradient(circle_at_center,var(--color-signal)_0%,transparent_70%)] animate-pulse-slow"></div>
                    </div>

                    <div className="relative z-10">
                        <h3 className="text-white text-2xl font-bold tracking-tight mb-2">Speak your mind.</h3>
                        <p className="text-white/40 text-sm font-light">Secure, intent-based ingestion active.</p>
                    </div>

                    <div className="relative z-10 flex flex-col items-center gap-8 my-12">
                        <button
                            onClick={onToggleRecord}
                            className={`w-36 h-36 rounded-full flex items-center justify-center transition-all duration-500 shadow-2xl ${isRecording ? 'bg-signal animate-pulse ring-[20px] ring-signal/10' : 'bg-white hover:bg-paper'
                                }`}
                        >
                            <i data-lucide={isRecording ? "square" : "mic"} className={`w-12 h-12 ${isRecording ? 'text-white' : 'text-black'}`}></i>
                        </button>
                        <span className="font-data text-[12px] text-white tracking-[0.2em] font-bold">{recordingText.toUpperCase()}</span>

                        {!isRecording && (
                            <button
                                onClick={() => onLoadMock('CHINESE_NEW_ARRIVAL')}
                                className="mt-4 px-4 py-2 border border-white/20 rounded-full text-[10px] text-white/60 hover:text-white hover:border-white/40 transition-all font-data uppercase"
                            >
                                Run Mock: Chinese New Arrival
                            </button>
                        )}
                    </div>

                    <div className="relative z-10 bg-white/5 border border-white/10 rounded-2xl p-6 min-h-[100px]">
                        <p className="text-white/30 text-[10px] font-data mb-2">DECODED_TRANSCRIPT</p>
                        <p className="text-white text-base italic leading-relaxed">
                            {transcript || "Waiting for signal..."}
                        </p>
                    </div>
                </div>

                <div className="bg-paper rounded-brutalist p-10 flex flex-col border border-black/5 shadow-2xl">
                    <h3 className="text-2xl font-bold tracking-tight mb-8">System Telemetry</h3>
                    <div className="flex-1 overflow-y-auto pr-4 hide-scrollbar flex flex-col gap-4 font-data text-xs">
                        {logs.map((log, i) => (
                            <div key={i} className="flex gap-4 p-4 bg-white rounded-xl border border-black/5 hover:border-black/20 transition-all">
                                <span className="text-black/30 shrink-0">{log.time}</span>
                                <span className={log.type === 'error' ? 'text-signal' : 'text-black/60'}>{log.message}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        const TasksView = ({ tasks, onSubmit }) => (
            <div className="max-w-4xl mx-auto space-y-6 pb-20">
                <h2 className="text-5xl font-bold tracking-tighter mb-12">Protocol Queue</h2>
                {tasks.length === 0 ? (
                    <div className="text-black/20 text-xl font-medium py-20 text-center border-2 border-dashed border-black/10 rounded-brutalist">
                        Queue empty. Speak to initialize flows.
                    </div>
                ) : (
                    <div className="space-y-6">
                        {tasks.map((task, i) => (
                            <div key={i} className="bg-paper rounded-brutalist p-10 border border-black/5 shadow-xl flex flex-col md:flex-row gap-8 items-start">
                                <div className="flex-1">
                                    <div className="flex items-center gap-4 mb-4">
                                        <span className="font-data text-signal text-sm">0{i + 1}</span>
                                        <h4 className="text-3xl font-bold tracking-tight">{task.title}</h4>
                                        <span className="text-[10px] font-data bg-black text-white px-2 py-1 rounded ml-2 uppercase tracking-widest">{task.status}</span>
                                    </div>
                                    <p className="text-black/60 mb-6">{task.description}</p>
                                    <div className="flex flex-wrap gap-2">
                                        {task.links?.map((l, j) => (
                                            <a key={j} href={l.url} className="text-[10px] font-data border border-black/10 px-3 py-1 rounded-full hover:bg-black hover:text-white transition-all uppercase">{l.title}</a>
                                        ))}
                                    </div>
                                </div>
                                <div className="w-full md:w-64">
                                    {task.status !== 'completed' && (
                                        <button
                                            onClick={() => onSubmit(task, "proceed")}
                                            className="w-full btn-magnetic bg-signal text-white py-4 rounded-xl font-bold text-sm"
                                        >
                                            <span className="btn-text">Proceed</span>
                                        </button>
                                    )}
                                    {task.monitoredUpdates && (
                                        <div className="bg-black/5 rounded-xl p-4 border border-black/5 mt-4">
                                            <p className="text-[10px] font-data text-black/40 mb-3 uppercase flex items-center gap-2">
                                                <span className="w-1.5 h-1.5 bg-signal rounded-full animate-pulse"></span>
                                                VERIFIED_LOG_STREAM
                                            </p>
                                            <div className="space-y-2">
                                                {task.monitoredUpdates.map((update, idx) => (
                                                    <p key={idx} className="text-[10px] font-data text-black/60 leading-relaxed border-l-2 border-black/5 pl-3 py-0.5">
                                                        {update}
                                                    </p>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );

        // --- Main App Controller ---

        const App = () => {
            const [view, setView] = useState('landing');
            const [activeTab, setTab] = useState('dash');

            // App State
            const [transcript, setTranscript] = useState('');
            const [contextFacts, setFacts] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [logs, setLogs] = useState([]);
            const [apiCalls, setApiCalls] = useState([]);

            const addLog = (message, type = 'info') => {
                const now = new Date();
                const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
                setLogs(prev => [{ time, message, type }, ...prev]);
            };

            const processAudio = async (blob) => {
                addLog('UPLOADING_AUDIO_BYTESTREAM...', 'system');
                try {
                    const formData = new FormData();
                    formData.append('file', blob, 'query.webm');
                    const res = await fetch(`${BACKEND_URL}/transcribe`, { method: 'POST', body: formData });
                    const data = await res.json();
                    const text = data.text || "I moved here three months ago and just started working a new job in California. I don't know what forms I need.";
                    setTranscript(text);
                    addLog('DECODE_SUCCESS: ' + text.substring(0, 30) + '...', 'agent');

                    const agentRes = await fetch(`${BACKEND_URL}/agent/process?text=${encodeURIComponent(text)}`, { method: 'POST' });
                    const agentData = await agentRes.json();

                    setFacts(agentData.context_facts);
                    setApiCalls(agentData.api_calls || []);
                    setTasks(agentData.inferred_tasks.map(t => ({ ...t, isProcessing: false })));
                    addLog('PROTOCOL_MAPPING_COMPLETE', 'agent');
                } catch (err) {
                    addLog('NETWORK_ERROR: FALLBACK_EMULATED', 'error');
                    // Mock data if server is down
                    setFacts([{ entity: 'Arrival', value: '3 months ago' }, { entity: 'Status', value: 'New Employment' }]);
                    setTasks([{ id: 1, title: 'I-9 Card Request', description: 'Employment eligibility verification for CA employer.', status: 'pending', action: 'Submit Info' }]);
                }
            };

            const submitTaskForm = async (task, input) => {
                addLog(`EXECUTING_SUBPROTOCOL: ${task.title}`, 'system');
                try {
                    const res = await fetch(`${BACKEND_URL}/agent/monitor`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ task_id: task.id, user_input: input })
                    });
                    const data = await res.json();
                    setTasks(prev => prev.map(t => t.id === task.id ? {
                        ...t,
                        status: 'completed',
                        monitoredInfo: data.message,
                        monitoredUpdates: data.updates
                    } : t));
                    addLog(`VERIFICATION_SUCCESS: ${task.title}`, 'agent');
                } catch (err) {
                    addLog('VERIFICATION_TIMEOUT', 'error');
                }
            };

            const { isRecording, recordingText, start, stop } = useAudioRecorder(addLog, processAudio);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [view, activeTab, tasks]);

            if (view === 'landing') {
                return (
                    <main className="relative">
                        <Navbar onEnterApp={() => setView('app')} />
                        <Hero onEnterApp={() => setView('app')} />
                        <Features />
                        <footer className="p-20 bg-black text-white rounded-t-[4rem]">
                            <h2 className="text-4xl font-bold tracking-tighter">LIFEOPS</h2>
                            <p className="text-white/40 mt-4 uppercase font-data text-xs tracking-widest">© 2026 BRUTALIST_SIGNAL_MODULE</p>
                        </footer>
                    </main>
                );
            }

            return (
                <div className="h-screen w-full flex bg-offwhite text-black overflow-hidden font-heading">
                    <Sidebar activeTab={activeTab} setTab={setTab} onExit={() => setView('landing')} />
                    <main className="flex-1 overflow-y-auto p-12 hide-scrollbar">
                        {activeTab === 'dash' && (
                            <Dashboard
                                logs={logs}
                                isRecording={isRecording}
                                recordingText={recordingText}
                                onToggleRecord={isRecording ? stop : start}
                                transcript={transcript}
                                onLoadMock={(id) => {
                                    const p = PERSONAS[id];
                                    setTranscript(p.transcript);
                                    setFacts(p.facts);
                                    setTasks(p.tasks);
                                    setApiCalls(p.apiCalls || []);
                                    setLogs(prev => [
                                        ...p.logs.map(l => ({ ...l, time: new Date().toLocaleTimeString() })),
                                        ...prev
                                    ]);
                                    addLog(`MOCK_PROTOCOL_LOADED: ${id}`, 'system');
                                }}
                            />
                        )}
                        {activeTab === 'tasks' && <TasksView tasks={tasks} onSubmit={submitTaskForm} />}
                        {activeTab === 'profile' && (
                            <div className="max-w-4xl mx-auto">
                                <h1 className="text-5xl font-bold tracking-tighter mb-12">Digital Passport</h1>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {contextFacts.map((f, i) => (
                                        <div key={i} className="bg-paper p-8 rounded-brutalist border border-black/5 shadow-xl">
                                            <span className="font-data text-signal text-[10px] uppercase tracking-widest block mb-1">{f.entity}</span>
                                            <span className="text-xl font-bold">{f.value}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        {activeTab === 'map' && (
                            <div className="h-full flex flex-col">
                                <h1 className="text-5xl font-bold tracking-tighter mb-8 shrink-0">Reasoning Map</h1>
                                <div className="flex-1 min-h-[500px]">
                                    <JourneyMap facts={contextFacts} apiCalls={apiCalls} />
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>